name: "Backend - Deploy Lambda Functions"

on:
  workflow_run:
    workflows: ["Build Serverless Backend Lambda Functions"]
    types: [completed]

  workflow_dispatch:
    inputs:
      version:
        type: string
        description: "Choose the version"
        required: true
        default: "dev"
      instance:
        type: choice
        description: "Choose the instance"
        required: true
        default: "dev"
        options:
          - dev
          - ua
          - preprod
          - prod

permissions:
  id-token: write
  contents: read

jobs:
  getting-lambda-functions-names:
    name: Resolve inputs and list Lambda functions
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'  }}
    outputs:
      lambda-names: ${{ steps.lambda-names.outputs.names }}
      instance: ${{ steps.resolve.outputs.instance }}
      version: ${{ steps.resolve.outputs.version }}
    runs-on: ubuntu-latest
    steps:
      - name: Assuming federated role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ vars.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_FED_ROLE_ARN }}
          role-session-name: Federal

      - name: Check version existence
        if: github.event_name == 'workflow_dispatch'
        shell: bash
        run: |
          echo "Checking version: $VERSION"

          if aws s3 ls "s3://$BUCKET/backend/${{ inputs.version }}/" > /dev/null 2>&1; then
            echo "Version exists âœ”"
          else
            echo "[X] Wrong Version Number:"
            exit 2
          fi

      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Resolve version and instance inputs (dispatch)
        id: resolve
        shell: bash
        run: |
          echo "SHA=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_ENV
          git fetch --tags
          TAG=$(git tag --points-at $SHA)
          EVENT="${{ github.event.workflow_run.event }}"
          BRANCH="${{ github.ref_name }}"

          echo "EVENT=$EVENT"
          echo "BRANCH=$BRANCH"
          echo "TAG=$TAG"

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
            echo "instance=${{ inputs.instance }}" >> $GITHUB_OUTPUT
          elif [[ "$EVENT" == "pull_request" && "$BRANCH" == "dev" ]]; then
            echo "version=dev" >> $GITHUB_OUTPUT
            echo "instance=dev" >> $GITHUB_OUTPUT
          else
            echo "version=$TAG" >> $GITHUB_OUTPUT
            echo "instance=ua" >> $GITHUB_OUTPUT
          fi

      - name: List Lambda function names from S3
        id: lambda-names
        run: |
          S3_ARRAY=()
          while read f; do
            NAME=$(basename "$f")
            NAME="${NAME%.*}"
            S3_ARRAY+=("\"$NAME\"")
          done < <(aws s3 ls s3://${{ secrets.BUCKET_NAME }}/backend/${{ steps.resolve.outputs.version }}/ --recursive | awk '{print $4}')
          IFS=,
          JSON="[${S3_ARRAY[*]}]"
          echo "names=$JSON" >> $GITHUB_OUTPUT

  download-lambda-from-s3:
    name: Download Lambda archives from S3
    needs: getting-lambda-functions-names
    runs-on: ubuntu-latest
    strategy:
      matrix:
        lambda: ${{ fromJSON(needs.getting-lambda-functions-names.outputs.lambda-names) }}
    steps:
      - name: Assuming federated role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ vars.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_FED_ROLE_ARN }}
          role-session-name: Federal

      - name: Create lambdas directory
        run: mkdir -p ./lambdas

      - name: Download Lambda archive from S3
        run: aws s3 cp s3://${{ secrets.BUCKET_NAME }}/backend/${{ needs.getting-lambda-functions-names.outputs.version }}/${{ matrix.lambda }}.zip ./lambdas/${{ matrix.lambda }}.zip

      - name: Upload Lambda archive as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.lambda }}
          path: ./lambdas/${{ matrix.lambda }}.zip

  deploy-lambda-function:
    name: Deploy Lambda functions
    needs: [getting-lambda-functions-names, download-lambda-from-s3]
    runs-on: ubuntu-latest
    environment: ${{ needs.getting-lambda-functions-names.outputs.instance }}
    strategy:
      matrix:
        lambda: ${{ fromJSON(needs.getting-lambda-functions-names.outputs.lambda-names) }}
    steps:
      - name: Assuming federated role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ vars.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_FED_ROLE_ARN }}
          role-session-name: Federal

      - name: Download Lambda archive from artifact
        uses: actions/download-artifact@v7
        with:
          name: ${{ matrix.lambda }}

      - name: Update Lambda function code
        run: |
          aws lambda update-function-code \
            --function-name ${{ matrix.lambda }}-${{ needs.getting-lambda-functions-names.outputs.instance }} \
            --zip-file fileb://${{ github.workspace }}/${{ matrix.lambda }}.zip

      - name: Merge and set Lambda environment variables
        env:
          NEW_VARS: '{"MS_VERSION":"${{ needs.getting-lambda-functions-names.outputs.version }}"}'
        run: |
          EXISTING=$(aws lambda get-function-configuration \
            --function-name ${{ matrix.lambda }} \
            --query 'Environment.Variables' \
            --output json) || EXISTING='{}'
          EXISTING=${EXISTING:-'{}'}
          MERGED=$(echo "$EXISTING" "$NEW_VARS" | jq -s '.[0] // {} | . * .[1]')
          aws lambda update-function-configuration \
            --function-name ${{ matrix.lambda }} \
            --environment "{\"Variables\":$MERGED}"
